---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: build
  namespace: rust-rest-build
spec:
  resources:
    - name: source
      type: git
    - name: image
      type: image
  tasks:
    - name: get-git-commit
      taskRef:
        name: git-commit
        kind: Task
      resources:
        inputs:
          - name: source
            resource: source
      workspaces:
        - name: git-source
          workspace: pipeline-ws1
    - name: get-is-tag
      taskRef:
        name: is-tags
        kind: Task
      params:
        - name: git-tag
          value: "$(tasks.get-git-commit.results.git-sha)"
      workspaces:
        - name: git-source
          workspace: pipeline-ws1
    - name: test-and-build
      when:
        - input: "$(tasks.get-git-commit.results.git-sha)"
          operator: notin
          values:
            - "$(tasks.get-is-tag.results.is-tag)"
      taskRef:
        name: rust-unit-and-build
        kind: Task
      runAfter:
        - get-git-commit
        - get-is-tag
      params:
        - name: commit
          value: "$(tasks.get-git-commit.results.git-sha)"
        - name: tag
          value: "$(tasks.get-is-tag.results.is-tag)"
      resources:
        outputs:
          - name: image
            resource: image
      workspaces:
        - name: git-source
          workspace: pipeline-ws1
    - name: prepare-dev-env
      taskRef:
        name: kustomize
        kind: Task
      runAfter:
        - test-and-build
      resources:
        inputs:
          - name: source
            resource: source
      params:
        - name: env
          value: kustomize/dev
    - name: promote-image-dev
      taskRef:
        name: promote
        kind: Task
      runAfter:
        - prepare-dev-env
      params:
        - name: env
          value: dev
        - name: commit
          value: "$(tasks.get-git-commit.results.git-sha)"
      workspaces:
        - name: git-source
          workspace: pipeline-ws1
    - name: deploy-verify-dev
      taskRef:
        name: deploy-and-verify
        kind: Task
      runAfter:
        - promote-image-dev
      params:
        - name: env
          value: dev
        - name: commit
          value: "$(tasks.get-git-commit.results.git-sha)"
      workspaces:
        - name: git-source
          workspace: pipeline-ws1
  workspaces:
    - name: pipeline-ws1
